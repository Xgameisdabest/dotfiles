#!/usr/bin/env bash

#COULD NOT FIND THE ORIGINAL AUTHOR
#THIS SCRIPT WAS MODIFIED BY ME (Xgameisdabest, aka xytozine)

source ~/.config/dtf-config/config

#when add new entry make sure to add 40 to height
main_menu_height=380px
main_menu_width=270px
full_menu_height=355px
notification_timeout=1100

bar_top=${bar_top:-false}
rofi_theme=${rofi_theme:-black}
animations=${animations:-true}
brightness_changes_by_power_mode=${brightness_changes_by_power_mode:-false}

if [[ $bar_top == "true" ]]; then
	location="north east"
	main_menu_x_offset=-110px
	main_menu_y_offset=70px
else
	location="south east"
	main_menu_x_offset=-110px
	main_menu_y_offset=-70px
fi

if [[ $LAUNCHED_FROM_SETTINGS == "true" ]]; then
	location="center"
	main_menu_x_offset=0px
	main_menu_y_offset=0px
fi

if [[ $rofi_theme == "white" ]]; then
	path_to_theme="~/.config/rofi/rofi_theme/white/white.rasi"
else
	path_to_theme="~/.config/rofi/rofi_theme/black/black.rasi"
fi

main_menu() {
	# Suppress acpi errors on desktops
	if ! acpi -b &>/dev/null; then
		time_left="AC"
	else
		time_left=$(acpi 2>/dev/null | grep -oE '[0-9]{2}:[0-9]{2}:[0-9]{2}')
		time_left=${time_left:-"Full"}
	fi

	# Handle missing battery directory
	if [ -d "/sys/class/power_supply/BAT0" ]; then
		status="$(</sys/class/power_supply/BAT0/status)"
		bat_percentage="$(</sys/class/power_supply/BAT0/capacity)%"
	else
		status="None"
		bat_percentage="N/A"
		time_left="AC Power"
	fi

	if hash powerprofilesctl 2>/dev/null; then
		power_mode_status="$(powerprofilesctl get)"
	elif hash auto-cpufreq 2>/dev/null; then
		power_mode_status="$(auto-cpufreq --get-state)"
	fi

	set_mode_performace() {
		powerprofilesctl set performance
		if [[ $XDG_CURRENT_DESKTOP == "Hyprland" ]]; then
			[[ $animations == "false" ]] && hyprctl keyword animations:enabled 0 || hyprctl keyword animations:enabled 1
			[[ $blur == "false" ]] && hyprctl keyword decoration:blur:enabled false || hyprctl keyword decoration:blur:enabled true
		fi
		notify-send -t $notification_timeout -h string:x-dunst-stack-tag:power_mode_status "Power set to performance mode 󰓅"
		if [[ $brightness_changes_by_power_mode == "true" ]]; then
			light -S 100
			~/.config/dunst/scripts/volume.sh brightness_status
		fi
	}

	set_mode_balanced() {
		powerprofilesctl set balanced
		if [[ $XDG_CURRENT_DESKTOP == "Hyprland" ]]; then
			[[ $animations == "false" ]] && hyprctl keyword animations:enabled 0 || hyprctl keyword animations:enabled 1
			hyprctl keyword decoration:blur:enabled false
		fi
		notify-send -t $notification_timeout -h string:x-dunst-stack-tag:power_mode_status "Power set to balance mode 󰾅"
		if [[ $brightness_changes_by_power_mode == "true" ]]; then
			light -S 79
			~/.config/dunst/scripts/volume.sh brightness_status
		fi
	}

	set_mode_power_saver() {
		powerprofilesctl set power-saver
		if [[ $XDG_CURRENT_DESKTOP == "Hyprland" ]]; then
			hyprctl keyword animations:enabled 0
			hyprctl keyword decoration:blur:enabled false
			pkill -f "kitty.*--class=kitty-bg"
		fi
		notify-send -t $notification_timeout -h string:x-dunst-stack-tag:power_mode_status "Power set to power-saver mode 󰾆"
		if [[ $brightness_changes_by_power_mode == "true" ]]; then
			light -S 61
			~/.config/dunst/scripts/volume.sh brightness_status
		fi
	}

	rofi_cmd() {
		if [[ $power_mode_status == "performance" ]]; then
			row=1
		elif [[ $power_mode_status == "balanced" ]]; then
			row=2
		elif [[ $power_mode_status == "power-saver" ]]; then
			row=3
		else
			row=0
		fi

		# If launched from settings, override position and height
		if [[ $LAUNCHED_FROM_SETTINGS == "true" ]]; then
			location="center"
			main_menu_x_offset=0px
			main_menu_y_offset=0px

			# Calculate new height once and override the original variable
			numeric_height=$(echo $main_menu_height | tr -d 'px')
			main_menu_height="$((numeric_height + 40))px"

			# Also adjust the "full" menu height just in case the battery is full
			numeric_full_height=$(echo $full_menu_height | tr -d 'px')
			full_menu_height="$((numeric_full_height + 40))px"
		fi

		if command -v auto-cpufreq >/dev/null 2>&1; then
			[[ "$bat_percentage" == "100%" ]] && prompt="Full 󰂅 " || prompt=" $bat_percentage 󰁹 "
			if [[ $LAUNCHED_FROM_SETTINGS == "true" ]]; then
				rofi -dmenu -i -theme "$path_to_theme" -theme-str "window {height: 345px; width: $main_menu_width; location: $location; x-offset: $main_menu_x_offset; y-offset: $main_menu_y_offset;}" -theme-str "listview {columns: 1; layout: vertical;}" -selected-row 1 -mesg "$(echo -e " MODE: $power_mode_status\n INFO: $time_left")" -p " $prompt"
			else
				rofi -dmenu -i -theme "$path_to_theme" -theme-str "window {height: 310px; width: $main_menu_width; location: $location; x-offset: $main_menu_x_offset; y-offset: $main_menu_y_offset;}" -theme-str "listview {columns: 1; layout: vertical;}" -selected-row 1 -mesg "$(echo -e " MODE: $power_mode_status\n INFO: $time_left")" -p " $prompt"
			fi
		else
			# Battery Logic
			if [[ $status == "Discharging" ]]; then
				[[ "$bat_percentage" == "100%" ]] && prompt="Full 󰂅 " || prompt=" $bat_percentage 󰁹 "
				rofi -dmenu -i -theme "$path_to_theme" -theme-str "window {height: $main_menu_height; width: $main_menu_width; location: $location; x-offset: $main_menu_x_offset; y-offset: $main_menu_y_offset;}" -theme-str "listview {columns: 1; layout: vertical;}" -selected-row $row -mesg "$(echo -e " MODE: $power_mode_status\n TIME: $time_left")" -p "$prompt"
			elif [[ $status == "Charging" ]] || [[ $status == "Not charging" ]]; then
				[[ "$bat_percentage" == "100%" ]] && prompt="Full 󰂅 " || prompt=" $bat_percentage 󰂅 "
				rofi -dmenu -i -theme "$path_to_theme" -theme-str "window {height: $main_menu_height; width: $main_menu_width; location: $location; x-offset: $main_menu_x_offset; y-offset: $main_menu_y_offset;}" -theme-str "listview {columns: 1; layout: vertical;}" -selected-row $row -mesg "$(echo -e " MODE: $power_mode_status\n FULL: $time_left")" -p "$prompt"
			elif [[ $status == "Full" ]]; then
				rofi -dmenu -i -theme "$path_to_theme" -theme-str "window {height: $full_menu_height; width: $main_menu_width; location: $location; x-offset: $main_menu_x_offset; y-offset: $main_menu_y_offset;}" -theme-str "listview {columns: 1; layout: vertical;}" -selected-row $row -mesg "$(echo -e " MODE: $power_mode_status")" -p " Full 󱐋 "
			else
				rofi -dmenu -i -theme "$path_to_theme" -theme-str "window {height: $main_menu_height; width: $main_menu_width; location: $location; x-offset: $main_menu_x_offset; y-offset: $main_menu_y_offset;}" -theme-str "listview {columns: 1; layout: vertical;}" -selected-row $row -mesg "$(echo -e " MODE: $power_mode_status\n STATUS: Desktop")" -p " AC 󰚥 "
			fi
		fi
	}

	# Options
	quit="Exit 󰈆 "
	back="Back 󰌍"
	performance='󰓅  Performance'
	medium='󰾅  Balanced'
	power='󰾆  Power Saver'
	power_manager="󰖯  Power Manager"
	auto_cpufreq="󰖯  auto-cpufreq"

	run_rofi() {
		# Create the base list of options
		if command -v auto-cpufreq >/dev/null 2>&1; then
			options="$power_manager\n$auto_cpufreq"
		else
			options="$power_manager\n$performance\n$medium\n$power"
		fi

		# If launched from settings, prepend the Back button
		if [[ $LAUNCHED_FROM_SETTINGS == "true" ]]; then
			echo -e "$options\n$back\n$quit" | rofi_cmd
		else
			echo -e "$options\n$quit" | rofi_cmd
		fi
	}

	# Actions
	chosen="$(run_rofi)"
	case ${chosen} in
	"") exit ;;
	$quit) exit ;;
	$back)
		~/.config/rofi/modules/rofi-user-settings
		exit
		;;
	$performance)
		set_mode_performace
		main_menu
		;;
	$medium)
		set_mode_balanced
		main_menu
		;;
	$power)
		set_mode_power_saver
		main_menu
		;;
	$power_manager) xfce4-power-manager-settings ;;
	$auto_cpufreq) auto-cpufreq-gtk ;;
	esac
}

main_menu
