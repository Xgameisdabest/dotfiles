#!/usr/bin/env bash

#COULD NOT FIND THE ORIGINAL AUTHOR
#THIS SCRIPT WAS MODIFIED BY ME (Xgameisdabest, aka xytozine)

source ~/.config/dtf-config/config

#when add new entry make sure to add 35 to height
main_menu_height=380px
main_menu_width=270px
full_menu_height=355px
notification_timeout=1100

bar_top=${bar_top:-false}
rofi_theme=${rofi_theme:-black}
animations=${animations:-true}
brightness_changes_by_power_mode=${brightness_changes_by_power_mode:-false}

if [[ $bar_top == "true" ]]; then
	location="north east"

	main_menu_x_offset=-110px
	main_menu_y_offset=70px
else
	location="south east"

	main_menu_x_offset=-110px
	main_menu_y_offset=-70px
fi

if [[ $rofi_theme == "white" ]]; then
	path_to_theme="~/.config/rofi/rofi_theme/white/white.rasi"
else
	path_to_theme="~/.config/rofi/rofi_theme/black/black.rasi"
fi

main_menu() {
	#main
	time_left=$(acpi | grep -oP '\d{2}:\d{2}:\d{2}(?= (remaining|until charged))')
	if [ -d "/sys/class/power_supply/BAT0" ]; then
		status="$(</sys/class/power_supply/BAT0/status)"
		bat_percentage="$(</sys/class/power_supply/BAT0/capacity)%"
	else
		status="null"
		bat_percentage="null"
	fi
	power_mode_status="$(powerprofilesctl get)"

	set_mode_performace() {
		powerprofilesctl set performance

		if [[ $XDG_CURRENT_DESKTOP == "Hyprland" ]]; then
			if [[ $animations == "false" ]]; then
				hyprctl keyword animations:enabled 0
			else
				hyprctl keyword animations:enabled 1
			fi

			if [[ $blur == "false" ]]; then
				hyprctl keyword decoration:blur:enabled false
			else
				hyprctl keyword decoration:blur:enabled true
			fi
		fi

		notify-send -t $notification_timeout -h string:x-dunst-stack-tag:power_mode_status "Power set to performance mode 󰓅"

		if [[ $brightness_changes_by_power_mode == "true" ]]; then
			light -S 100
			~/.config/dunst/scripts/volume.sh brightness_status
		fi
	}

	set_mode_balanced() {
		powerprofilesctl set balanced

		if [[ $XDG_CURRENT_DESKTOP == "Hyprland" ]]; then
			if [[ $animations == "false" ]]; then
				hyprctl keyword animations:enabled 0
			else
				hyprctl keyword animations:enabled 1
			fi

			hyprctl keyword decoration:blur:enabled false

		fi

		notify-send -t $notification_timeout -h string:x-dunst-stack-tag:power_mode_status "Power set to balance mode 󰾅"

		if [[ $brightness_changes_by_power_mode == "true" ]]; then
			light -S 79
			~/.config/dunst/scripts/volume.sh brightness_status
		fi

	}

	set_mode_power_saver() {
		powerprofilesctl set power-saver

		if [[ $XDG_CURRENT_DESKTOP == "Hyprland" ]]; then
			hyprctl keyword animations:enabled 0
			hyprctl keyword decoration:blur:enabled false
			pkill -f "kitty.*--class=kitty-bg"
		fi
		notify-send -t $notification_timeout -h string:x-dunst-stack-tag:power_mode_status "Power set to power-saver mode 󰾆"

		if [[ $brightness_changes_by_power_mode == "true" ]]; then
			light -S 61
			~/.config/dunst/scripts/volume.sh brightness_status

		fi

	}

	rofi_cmd() {
		if [[ $power_mode_status == "performance" ]]; then
			row=1
		elif [[ $power_mode_status == "balanced" ]]; then
			row=2
		elif [[ $power_mode_status == "power-saver" ]]; then
			row=3
		fi

		if command -v auto-cpufreq >/dev/null 2>&1; then
			rofi -dmenu -i -theme $path_to_theme -theme-str "window {height: 310px; width: $main_menu_width; location: $location; x-offset: $main_menu_x_offset; y-offset: $main_menu_y_offset;}" -theme-str "listview {columns: 1; layout: vertical;}" -selected-row 2 -mesg "$(echo -e " MODE: $power_mode_status\n TIME: $time_left")" -p " $bat_percentage 󰁹 "
		else
			if [[ $status == "Discharging" ]]; then
				rofi -dmenu -i -theme $path_to_theme -theme-str "window {height: $main_menu_height; width: $main_menu_width; location: $location; x-offset: $main_menu_x_offset; y-offset: $main_menu_y_offset;}" -theme-str "listview {columns: 1; layout: vertical;}" -selected-row $row -mesg "$(echo -e " MODE: $power_mode_status\n TIME: $time_left")" -p " $bat_percentage 󰁹 "
			elif [[ $status == "Charging" ]] || [[ $status == "Not charging" ]]; then
				rofi -dmenu -i -theme $path_to_theme -theme-str "window {height: $main_menu_height; width: $main_menu_width; location: $location; x-offset: $main_menu_x_offset; y-offset: $main_menu_y_offset;}" -theme-str "listview {columns: 1; layout: vertical;}" -selected-row $row -mesg "$(echo -e " MODE: $power_mode_status\n FULL: $time_left")" -p " $bat_percentage 󰂅 "
			elif [[ $status == "Full" ]]; then
				rofi -dmenu -i -theme $path_to_theme -theme-str "window {height: $full_menu_height; width: $main_menu_width; location: $location; x-offset: $main_menu_x_offset; y-offset: $main_menu_y_offset;}" -theme-str "listview {columns: 1; layout: vertical;}" -selected-row $row -mesg "$(echo -e " MODE: $power_mode_status")" -p " Full 󱐋 "
			fi
		fi

	}

	# Options
	quit="Exit 󰈆 "
	performance='󰓅  Performance'
	medium='󰾅  Balanced'
	power='󰾆  Power Saver'
	power_manager="󰖯  Power Manager"
	auto_cpufreq="󰖯  auto-cpufreq"

	run_rofi() {
		if command -v auto-cpufreq >/dev/null 2>&1; then
			echo -e "$power_manager\n$auto_cpufreq\n$quit" | rofi_cmd
		else
			echo -e "$power_manager\n$performance\n$medium\n$power\n$quit" | rofi_cmd
		fi
	}

	# Actions
	chosen="$(run_rofi)"
	case ${chosen} in
	"")
		exit
		;;
	$quit)
		exit
		;;
	$performance)
		set_mode_performace
		main_menu
		;;
	$medium)
		set_mode_balanced
		main_menu
		;;
	$power)
		set_mode_power_saver
		main_menu
		;;
	$power_manager)
		xfce4-power-manager-settings
		;;
	$auto_cpufreq)
		auto-cpufreq-gtk
		;;
	esac
}

main_menu
